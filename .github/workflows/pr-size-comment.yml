name: PR Size Notifier

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: read
  issues: write

jobs:
  check-pr-size:
    runs-on: ubuntu-latest
    steps:
      - name: Calculate PR size and comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.FORKED_REPO_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            // ì œì™¸í•  íŒŒì¼ íŒ¨í„´ (í”„ë¡ íŠ¸ + ë°±ì—”ë“œ)
            const excludedPatterns = [
              /^frontend\/package-lock\.json$/, /^frontend\/.*\.lock$/, /^docs\//,
              /^backend\/.*\/target\//, /^backend\/.*\/build\//, 
              /^backend\/.*\/pom\.xml$/, /^backend\/.*\/build\.gradle/, /^backend\/.*\/settings\.gradle/,
              /^backend\/.*\.(properties|yml|yaml)$/, 
              /^frontend\/public\//, /^frontend\/src\/assets\//
            ];

            const filteredFiles = files.filter(file => !excludedPatterns.some(pattern => pattern.test(file.filename)));

            const totalAdditions = filteredFiles.reduce((sum, file) => sum + file.additions, 0);
            const totalDeletions = filteredFiles.reduce((sum, file) => sum + file.deletions, 0);
            const totalChanges = totalAdditions + totalDeletions;

            let sizeLabel, message;

            if (totalAdditions <= 50) {
              sizeLabel = 'XS';
              message = `âœ… ì‘ì€ ë³€ê²½ì…ë‹ˆë‹¤. (+${totalAdditions}/-${totalDeletions}, ì´ ${totalChanges}ì¤„) ë¹ ë¥´ê²Œ ë¦¬ë·°í•  ìˆ˜ ìˆì–´ìš”.`;
            } else if (totalAdditions <= 200) {
              sizeLabel = 'S';
              message = `ğŸ‘ ì ì ˆí•œ í¬ê¸°ì…ë‹ˆë‹¤. (+${totalAdditions}/-${totalDeletions}, ì´ ${totalChanges}ì¤„) ë¦¬ë·°í•˜ê¸° ì¢‹ë„¤ìš”.`;
            } else if (totalAdditions <= 500) {
              sizeLabel = 'M';
              message = `â„¹ï¸ ë‹¤ì†Œ í° PRì…ë‹ˆë‹¤. (+${totalAdditions}/-${totalDeletions}, ì´ ${totalChanges}ì¤„) ì§‘ì¤‘í•´ì„œ ë¦¬ë·°í•´ ì£¼ì„¸ìš”.`;
            } else if (totalAdditions <= 1000) {
              sizeLabel = 'L';
              message = `âš ï¸ í° ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤. (+${totalAdditions}/-${totalDeletions}, ì´ ${totalChanges}ì¤„) ë¦¬ë·°ì— ì‹œê°„ì´ ì¢€ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”.`;
            } else {
              sizeLabel = 'XL';
              message = `ğŸš¨ ë§¤ìš° í° PRì…ë‹ˆë‹¤. (+${totalAdditions}/-${totalDeletions}, ì´ ${totalChanges}ì¤„) ê°€ëŠ¥í•˜ë‹¤ë©´ ì‘ì—…ì„ ë‚˜ëˆ ì„œ ì œì¶œí•´ ì£¼ì„¸ìš”.`;
            }

            const marker = '<!-- pr-size-marker -->';

            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ìˆìœ¼ë©´ ì‚­ì œ
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            const existingComment = comments.find(c => c.body.includes(marker));
            if (existingComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
              });
            }

            // ìƒˆ ì½”ë©˜íŠ¸ ì‘ì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `${marker}\n### ğŸ” PR í¬ê¸° ì²´í¬ ê²°ê³¼ (${sizeLabel})\n${message}`
            });
